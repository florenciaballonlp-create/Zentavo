name: ğŸ¤– Android Build

on:
  push:
    branches: [ main ]
    paths:
      - 'lib/**'
      - 'android/**'
      - 'assets/**'
      - 'pubspec.yaml'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-android:
    name: ğŸ¤– Build Android APK
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: '17'
      
      - name: ğŸ“± Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true
      
      - name: ğŸ“¦ Install dependencies
        run: flutter pub get
      
      - name: ğŸ” Analyze code
        run: flutter analyze --no-fatal-infos
        continue-on-error: true
      
      - name: ğŸ§ª Run tests
        run: flutter test
        continue-on-error: true
      
      - name: ğŸ—ï¸ Build APK
        run: flutter build apk --release
      
      - name: ğŸ—ï¸ Build App Bundle (AAB)
        run: flutter build appbundle --release
      
      - name: ğŸ“¤ Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: Zentavo-Android-APK
          path: build/app/outputs/flutter-apk/app-release.apk
          retention-days: 90
      
      - name: ğŸ“¤ Upload App Bundle
        uses: actions/upload-artifact@v4
        with:
          name: Zentavo-Android-AAB
          path: build/app/outputs/bundle/release/app-release.aab
          retention-days: 90
      
      - name: ğŸ“Š APK Info
        run: |
          echo "### ğŸ“¦ Build Information" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**APK Size:** $(du -h build/app/outputs/flutter-apk/app-release.apk | cut -f1)" >> $GITHUB_STEP_SUMMARY
          echo "**AAB Size:** $(du -h build/app/outputs/bundle/release/app-release.aab | cut -f1)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Android build completed successfully!**" >> $GITHUB_STEP_SUMMARY

# ========================================
# BUILD FIRMADO (COMENTADO)
# ========================================
# Descomenta este job cuando tengas configurado el keystore de Android
# Requiere:
#   - Android keystore (.jks file)
#   - ContraseÃ±as del keystore
#   - Secretos configurados en GitHub (ver CONFIGURAR_GITHUB_ACTIONS.md)
# 
# build-android-signed:
#   name: ğŸ¤– Build Android (Signed for Play Store)
#   runs-on: ubuntu-latest
#   needs: build-android
#   
#   steps:
#     - name: ğŸ“¥ Checkout code
#       uses: actions/checkout@v4
#     
#     - name: ğŸ”§ Setup Java
#       uses: actions/setup-java@v3
#       with:
#         distribution: 'zulu'
#         java-version: '17'
#     
#     - name: ğŸ“± Setup Flutter
#       uses: subosito/flutter-action@v2
#       with:
#         channel: 'stable'
#     
#     - name: ğŸ“¦ Install dependencies
#       run: flutter pub get
#     
#     - name: ğŸ”‘ Setup Android signing
#       env:
#         ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
#       run: |
#         echo $ANDROID_KEYSTORE_BASE64 | base64 --decode > android/app/upload-keystore.jks
#         echo "storePassword=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}" > android/key.properties
#         echo "keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}" >> android/key.properties
#         echo "keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}" >> android/key.properties
#         echo "storeFile=upload-keystore.jks" >> android/key.properties
#     
#     - name: ğŸ—ï¸ Build signed APK
#       run: flutter build apk --release --split-per-abi
#     
#     - name: ğŸ—ï¸ Build signed App Bundle
#       run: flutter build appbundle --release
#     
#     - name: ğŸ“¤ Upload signed APKs
#       uses: actions/upload-artifact@v4
#       with:
#         name: Zentavo-Android-APKs-Signed
#         path: build/app/outputs/flutter-apk/*.apk
#         retention-days: 90
#     
#     - name: ğŸ“¤ Upload signed App Bundle
#       uses: actions/upload-artifact@v4
#       with:
#         name: Zentavo-Android-AAB-Signed
#         path: build/app/outputs/bundle/release/app-release.aab
#         retention-days: 90
#     
#     - name: ğŸ§¹ Cleanup
#       if: always()
#       run: rm -f android/app/upload-keystore.jks android/key.properties
